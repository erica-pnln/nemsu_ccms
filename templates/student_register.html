<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirm_password');
    const termsCheckbox = document.getElementById('terms');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Real-time password validation
    function validatePasswords() {
        if (password.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('Passwords do not match');
            confirmPassword.classList.add('is-invalid');
            confirmPassword.classList.remove('is-valid');
            
            // Show error message
            let errorDiv = confirmPassword.parentNode.querySelector('.password-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback password-error';
                confirmPassword.parentNode.appendChild(errorDiv);
            }
            errorDiv.textContent = 'Passwords do not match';
            return false;
        } else {
            confirmPassword.setCustomValidity('');
            confirmPassword.classList.remove('is-invalid');
            confirmPassword.classList.add('is-valid');
            
            // Remove error message
            const errorDiv = confirmPassword.parentNode.querySelector('.password-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            return true;
        }
    }
    
    // Password strength indicator
    function checkPasswordStrength() {
        const pass = password.value;
        const strengthText = document.getElementById('password-strength');
        
        if (!strengthText) {
            const div = document.createElement('div');
            div.id = 'password-strength';
            div.className = 'form-text mt-1';
            password.parentNode.appendChild(div);
        }
        
        const strengthDiv = document.getElementById('password-strength');
        let strength = 0;
        let message = '';
        let color = '';
        
        // Length check
        if (pass.length >= 8) strength++;
        if (pass.length >= 12) strength++;
        
        // Complexity checks
        if (/[a-z]/.test(pass)) strength++;
        if (/[A-Z]/.test(pass)) strength++;
        if (/[0-9]/.test(pass)) strength++;
        if (/[^A-Za-z0-9]/.test(pass)) strength++;
        
        // Determine strength level
        if (pass.length === 0) {
            message = 'Enter a password';
            color = 'text-muted';
        } else if (pass.length < 6) {
            message = 'Very weak';
            color = 'text-danger';
        } else if (strength <= 2) {
            message = 'Weak';
            color = 'text-danger';
        } else if (strength <= 4) {
            message = 'Good';
            color = 'text-warning';
        } else if (strength <= 5) {
            message = 'Strong';
            color = 'text-success';
        } else {
            message = 'Very strong';
            color = 'text-success';
        }
        
        strengthDiv.innerHTML = `<small class="${color}"><i class="fas fa-shield-alt me-1"></i> ${message}</small>`;
    }
    
    // Student ID validation
    function validateStudentId() {
        const studentIdInput = document.getElementById('student_id');
        const studentId = studentIdInput.value.trim().toUpperCase();
        
        // Remove any existing validation
        studentIdInput.classList.remove('is-invalid', 'is-valid');
        
        // Check for existing error message
        let errorDiv = studentIdInput.parentNode.querySelector('.studentid-error');
        if (errorDiv) {
            errorDiv.remove();
        }
        
        if (studentId.length < 3) {
            studentIdInput.classList.add('is-invalid');
            errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback studentid-error';
            errorDiv.textContent = 'Student ID must be at least 3 characters';
            studentIdInput.parentNode.appendChild(errorDiv);
            return false;
        }
        
        // Format validation (adjust based on your student ID format)
        if (!/^[A-Z0-9-]+$/.test(studentId)) {
            studentIdInput.classList.add('is-invalid');
            errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback studentid-error';
            errorDiv.textContent = 'Student ID can only contain letters, numbers, and hyphens';
            studentIdInput.parentNode.appendChild(errorDiv);
            return false;
        }
        
        studentIdInput.classList.add('is-valid');
        return true;
    }
    
    // Email validation
    function validateEmail() {
        const emailInput = document.getElementById('email');
        const email = emailInput.value.trim();
        
        emailInput.classList.remove('is-invalid', 'is-valid');
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            emailInput.classList.add('is-invalid');
            return false;
        }
        
        emailInput.classList.add('is-valid');
        return true;
    }
    
    // Form submission handler
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate all fields
        const isPasswordsValid = validatePasswords();
        const isStudentIdValid = validateStudentId();
        const isEmailValid = validateEmail();
        const isTermsAccepted = termsCheckbox.checked;
        
        if (!isTermsAccepted) {
            termsCheckbox.classList.add('is-invalid');
            alert('Please accept the Terms and Conditions');
            return false;
        } else {
            termsCheckbox.classList.remove('is-invalid');
        }
        
        if (!isPasswordsValid || !isStudentIdValid || !isEmailValid) {
            alert('Please fix the errors in the form before submitting.');
            return false;
        }
        
        // Disable submit button and show loading
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Registering...
            `;
        }
        
        // Submit the form
        this.submit();
    });
    
    // Real-time validation events
    password.addEventListener('input', function() {
        validatePasswords();
        checkPasswordStrength();
    });
    
    confirmPassword.addEventListener('input', validatePasswords);
    document.getElementById('student_id').addEventListener('blur', validateStudentId);
    document.getElementById('email').addEventListener('blur', validateEmail);
    
    // Terms checkbox validation
    termsCheckbox.addEventListener('change', function() {
        if (this.checked) {
            this.classList.remove('is-invalid');
        }
    });
    
    // Initial validation
    checkPasswordStrength();
});
</script>
